<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmotiVision AI</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00f2ff;
            --secondary-color: #7000ff;
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--bg-gradient);
            color: #e0e0e0;
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1, h2, h3, .navbar-brand, .emotion-label {
            font-family: 'Orbitron', sans-serif;
        }

        .navbar {
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
        }

        .navbar-brand {
            color: var(--primary-color) !important;
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
            font-weight: 700;
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid var(--glass-border);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #aaa;
        }

        /* Video Container */
        .video-wrapper {
            position: relative;
            padding: 4px;
            background: linear-gradient(45deg, var(--primary-color), transparent, var(--secondary-color));
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
        }

        .video-container {
            border-radius: 8px;
            overflow: hidden;
            background-color: #000;
            position: relative;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 4px;
            color: #00f2ff;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            border: 1px solid #00f2ff;
        }

        /* Emotion Badge */
        .emotion-badge {
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 0 0 20px currentColor;
            transition: color 0.5s ease;
        }
        
        .emotion-emoji {
            font-size: 4rem;
            display: block;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
        }

        /* Buttons */
        .btn-cyber {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .btn-cyber:hover:not(:disabled) {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 15px var(--primary-color);
        }

        .btn-cyber:disabled {
            border-color: #555;
            color: #555;
        }

        /* Timeline */
        .timeline-container {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) transparent;
        }
        
        .timeline-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 3px;
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <span style="color: #fff;">EMOTI</span>VISION <span style="font-size: 0.8em; color: var(--secondary-color);">AI</span>
            </a>
            <div class="d-flex">
                <span class="text-muted small align-self-center">v2.0.0</span>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px;">
        <div class="row">
            <!-- Video Feed -->
            <div class="col-lg-8 mb-4">
                <div class="video-wrapper">
                    <div class="video-container text-center">
                        <div class="video-overlay">LIVE FEED ‚óè REC</div>
                        <img src="{{ url_for('video_feed') }}" width="100%" alt="Video Feed" style="min-height: 480px; object-fit: contain;">
                    </div>
                </div>
                
                <!-- Timeline Section -->
                <div class="glass-card mt-4 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0" style="font-family: 'Orbitron'; color: #ccc;">Emotion History</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearTimeline()">Clear</button>
                    </div>
                    <div class="timeline-container" id="emotionTimeline">
                        <!-- Items added via JS -->
                    </div>
                </div>
            </div>

            <!-- Dashboard -->
            <div class="col-lg-4">
                <!-- Current Emotion Card -->
                <div class="glass-card mb-4">
                    <div class="card-header text-center">
                        Current State
                    </div>
                    <div class="card-body text-center py-4">
                        <div id="emotionEmoji" class="emotion-emoji">üòê</div>
                        <div id="dominantEmotion" class="emotion-badge" style="color: #ccc;">NEUTRAL</div>
                        <div class="mt-3">
                            <button id="snapshotBtn" class="btn btn-cyber w-100">
                                üì∏ Capture Snapshot
                            </button>
                            <div id="snapshotStatus" class="mt-2 small"></div>
                        </div>
                    </div>
                </div>

                <!-- Chart Card -->
                <div class="glass-card">
                    <div class="card-header">
                        Real-time Analysis
                    </div>
                    <div class="card-body">
                        <canvas id="emotionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Configuration
        const emotionConfig = {
            'angry': { color: '#ff4d4d', emoji: 'üò†' },
            'disgust': { color: '#2ecc71', emoji: 'ü§¢' },
            'fear': { color: '#9b59b6', emoji: 'üò±' },
            'happy': { color: '#f1c40f', emoji: 'üòÑ' },
            'sad': { color: '#3498db', emoji: 'üò¢' },
            'surprise': { color: '#e67e22', emoji: 'üò≤' },
            'neutral': { color: '#ecf0f1', emoji: 'üòê' },
            'error': { color: '#7f8c8d', emoji: '‚ö†Ô∏è' }
        };

        // Chart Initialization
        Chart.defaults.color = '#aaa';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
        
        const ctx = document.getElementById('emotionChart').getContext('2d');
        const emotionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['angry', 'disgust', 'fear', 'happy', 'sad', 'surprise', 'neutral'],
                datasets: [{
                    label: 'Confidence',
                    data: [0, 0, 0, 0, 0, 0, 100],
                    backgroundColor: [
                        'rgba(255, 77, 77, 0.7)',   // angry
                        'rgba(46, 204, 113, 0.7)',  // disgust
                        'rgba(155, 89, 182, 0.7)',  // fear
                        'rgba(241, 196, 15, 0.7)',  // happy
                        'rgba(52, 152, 219, 0.7)',  // sad
                        'rgba(230, 126, 34, 0.7)',  // surprise
                        'rgba(236, 240, 241, 0.7)'  // neutral
                    ],
                    borderColor: 'rgba(255,255,255,0.2)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        grid: { display: false }
                    },
                    y: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                },
                animation: {
                    duration: 200 // Faster animation for real-time feel
                }
            }
        });

        // Timeline Logic
        const timelineEl = document.getElementById('emotionTimeline');
        let lastLoggedEmotion = '';
        let lastLoggedTime = 0;

        function addToTimeline(emotion) {
            const now = Date.now();
            // Log only if emotion changes or every 5 seconds
            if (emotion !== lastLoggedEmotion || (now - lastLoggedTime > 5000)) {
                const timeString = new Date().toLocaleTimeString();
                const config = emotionConfig[emotion] || emotionConfig['neutral'];
                
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    <span><span style="color:${config.color}">${config.emoji}</span> ${emotion.toUpperCase()}</span>
                    <span class="text-muted small">${timeString}</span>
                `;
                
                timelineEl.prepend(item); // Add to top
                
                // Limit items
                if (timelineEl.children.length > 20) {
                    timelineEl.removeChild(timelineEl.lastChild);
                }

                lastLoggedEmotion = emotion;
                lastLoggedTime = now;
            }
        }

        function clearTimeline() {
            timelineEl.innerHTML = '';
        }

        // Update Dashboard Loop
        function updateDashboard() {
            fetch('/emotion_data')
                .then(response => {
                    if (!response.ok) throw new Error(`Status: ${response.status}`);
                    const contentType = response.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        throw new TypeError("Non-JSON response");
                    }
                    return response.json();
                })
                .then(data => {
                    const emotion = data.dominant_emotion ? data.dominant_emotion.toLowerCase() : 'neutral';
                    const config = emotionConfig[emotion] || emotionConfig['neutral'];

                    // Update Text & Emoji
                    const emotionEl = document.getElementById('dominantEmotion');
                    const emojiEl = document.getElementById('emotionEmoji');
                    
                    emotionEl.innerText = emotion.toUpperCase();
                    emotionEl.style.color = config.color;
                    emojiEl.innerText = config.emoji;
                    
                    // Update Chart
                    if (data.probabilities) {
                        const labels = emotionChart.data.labels;
                        const newData = labels.map(label => data.probabilities[label] || 0);
                        emotionChart.data.datasets[0].data = newData;
                        emotionChart.update('none'); // 'none' mode for performance
                    }

                    // Update Timeline
                    addToTimeline(emotion);
                })
                .catch(error => {
                    console.warn('Skipping update:', error.message);
                });
        }

        // Run update every 500ms
        setInterval(updateDashboard, 500);

        // Snapshot Logic
        document.getElementById('snapshotBtn').addEventListener('click', function() {
            const btn = this;
            const statusDiv = document.getElementById('snapshotStatus');
            btn.disabled = true;
            btn.innerHTML = '‚åõ Saving...';
            
            fetch('/snapshot', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        statusDiv.innerHTML = `<span class="text-success">‚úî Saved to ${data.filename}</span>`;
                    } else {
                        statusDiv.innerHTML = `<span class="text-danger">‚úñ ${data.message}</span>`;
                    }
                })
                .catch(err => {
                    statusDiv.innerHTML = `<span class="text-danger">‚úñ Error</span>`;
                })
                .finally(() => {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = 'üì∏ Capture Snapshot';
                        statusDiv.innerHTML = '';
                    }, 2000);
                });
        });
    </script>
</body>
</html>